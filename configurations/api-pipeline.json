{
  "description" : "Pipeline for parsing Apache HTTP Server access logs. Requires the geoip and user_agent plugins.",
  "processors" : [
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "message",
        "patterns" : [
          "%{IPORHOST:source.address} - %{DATA:user.name} \\[%{HTTPDATE:apache.access.time}\\] \"(?:%{WORD:http.request.method} %{DATA:url.original} HTTP/%{NUMBER:http.version}|-)?\" %{NUMBER:http.response.status_code:long} (?:%{NUMBER:http.response.body.bytes:long}|-)( \"%{DATA:http.request.referrer}\")?( \"%{DATA:user_agent.original}\")?( %{NUMBER:event.duration:long}|-)?"
        ]
      }
    },
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "url.original",
        "ignore_failure": true,
        "patterns" : [
          "/((int)|(ext)|(pub)|(gov))/((pls)|(geoserver))/%{WORD:labels.application}",
          "/((int)|(ext)|(pub)|(gov)|(datasets)|(appsdata))/%{WORD:labels.application}",
          "/%{WORD:labels.application}",
          "(?<labels.application>/)"
        ]
      }
    },
    {
      "lowercase": {
        "ignore_missing" : true,
        "field": "labels.application"
      }
    },
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "url.original",
        "ignore_failure": true,
        "patterns" : [
          "(?<labels.context>(/((int)|(ext)|(pub)|(gov))/((pls)|(geoserver))/[^/]*))",
          "(?<labels.context>(/((int)|(ext)|(pub)|(gov)|(datasets)|(appsdata))/[^/]*))",
          "(?<labels.context>(/[^/]*))"
        ]
      }
    },
    {
      "lowercase": {
        "ignore_missing" : true,
        "field": "labels.context"
      }
    },
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "url.original",
        "ignore_failure": true,
        "patterns" : [
          "(?<labels.prefix>(/[^/]*))"
        ]
      }
    },
    {
      "lowercase": {
        "ignore_missing" : true,
        "field": "labels.prefix"
      }
    },
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "log.file.path",
        "patterns" : [
          "^(/([^/]+/)*)(?<url.domain>.+)-access.*.log$"
        ]
      }
    },
    {
      "lowercase": {
        "ignore_missing" : true,
        "field": "url.domain"
      }
    },
    {
      "grok" : {
        "ignore_missing" : true,
        "field" : "url.original",
        "ignore_failure": true,
        "patterns" : [
          "%{URIPATH:url.path}"
        ]
      }
    },
    {
      "lowercase": {
        "ignore_missing" : true,
        "field": "url.path"
      }
    },
    {
      "grok" : {
        "field" : "source.address",
        "ignore_missing" : true,
        "patterns" : [
          "^(%{IP:source.ip}|%{HOSTNAME:source.domain})$"
        ]
      }
    },
    {
      "rename" : {
        "field" : "@timestamp",
        "target_field" : "event.created"
      }
    },
    {
      "date" : {
        "field" : "apache.access.time",
        "target_field" : "@timestamp",
        "formats" : [
          "dd/MMM/yyyy:H:m:s Z"
        ],
        "ignore_failure" : true
      }
    },
    {
      "remove" : {
        "field" : "apache.access.time",
        "ignore_failure" : true
      }
    },
    {
      "user_agent" : {
        "field" : "user_agent.original",
        "ignore_failure" : true
      }
    },
    {
      "geoip" : {
        "field" : "source.ip",
        "target_field" : "source.geo",
        "ignore_missing" : true
      }
    },
    {
      "geoip" : {
        "field" : "source.ip",
        "target_field" : "source.as",
        "properties" : [
          "asn",
          "organization_name"
        ],
        "ignore_missing" : true,
        "database_file" : "GeoLite2-ASN.mmdb"
      }
    },
    {
      "rename" : {
        "target_field" : "source.as.number",
        "ignore_missing" : true,
        "field" : "source.as.asn"
      }
    },
    {
      "rename" : {
        "field" : "source.as.organization_name",
        "target_field" : "source.as.organization.name",
        "ignore_missing" : true
      }
    },
    {
      "set": {
        "field": "event.outcome",
        "value": "unknown"
      }
    },
    {
      "set": {
        "if": "ctx.http.response.status_code >= 200 && ctx.http.response.status_code <400",
        "field": "event.outcome",
        "value": "success"
      }
    },
    {
      "set": {
        "if": "ctx.http.response.status_code >= 400 && ctx.http.response.status_code <600",
        "field": "event.outcome",
        "value": "failure"
      }
    },
    {
      "set": {
        "if": "ctx.http.response.status_code == 401 || ctx.http.response.status_code == 403",
        "field": "event.outcome",
        "value": "success"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'www.sitesandtrailsbc.ca'",
        "field": "labels.application",
        "value": "sitesandtrailsbc"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'aris.empr.gov.bc.ca'",
        "field": "labels.application",
        "value": "aris"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'propertyfile.gov.bc.ca'",
        "field": "labels.application",
        "value": "propertyfile"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'portal.nrs.gov.bc.ca'",
        "field": "labels.application",
        "value": "nros"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'www.mtonline.gov.bc.ca'",
        "field": "labels.application",
        "value": "mto"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'minfile.gov.bc.ca'",
        "field": "labels.application",
        "value": "minfile"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'apistore.nrs.gov.bc.ca'",
        "field": "labels.application",
        "value": "apistore"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'apipublisher.nrs.gov.bc.ca'",
        "field": "labels.application",
        "value": "apipublisher"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'apicarbon.nrs.gov.bc.ca'",
        "field": "labels.application",
        "value": "apicarbon"
      }
    },
    {
      "set": {
        "if": "ctx.url.domain == 'epayments.gov.bc.ca'",
        "field": "labels.application",
        "value": "epay"
      }
    },
    {
      "set": {
        "field": "url.full",
        "value": "//{{url.domain}}{{url.original}}"
      }
    },
    {
      "date_index_name" : {
        "field" : "@timestamp",
        "index_name_prefix" : "logs-access-7.6.2-",
        "date_rounding" : "d"
      }
    },
    {
      "remove" : {
        "field" : "message"
      }
    }
  ],
  "on_failure" : [
    {
      "set" : {
        "field" : "error.message",
        "value" : "{{ _ingest.on_failure_message }}"
      }
    }
  ]
}
